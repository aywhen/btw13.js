<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>btw13.js</title>
  </head>
  <body>
    
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js" charset="utf-8"></script>

    <script src="js/parser.js" charset="utf-8"></script>
    <script>
      var Election = function(results) {
        var self = this;
        // the raw result objects from the interim tallies.
        self.results = results;

        self._filter_admin = function(level) {
          // find the distinct set of administrative regions
          var fres = _.filter(self.results, function(r) { return r.admin_level === level; }),
              regs = _.map(fres, function(r) {
                return {
                  'id': r.admin_id, 
                  'label': r.admin_label,
                  'parent_id': r.parent_id
                };
              });
          return _.uniq(regs, function(r) { return r.id; })
        };

        // get a list of all electoral districts
        self.districts = _.memoize(_.partial(self._filter_admin, 'district'));

        // get a list of all federal states
        self.states = _.memoize(_.partial(self._filter_admin, 'state'));

        self.regularSeatsCount = _.memoize(function() {
          // calculate the number of regular (i.e. non excess mandate) seats.
          return self.districts().length * 2;
        });

        self._admin_results = function(level, id) {
          // get all raw results for one particular administrative zone (state, district).
          return _.filter(self.results, function(r) {
            return r.admin_level === level && r.admin_id === id;
          });
        }

        self.directMandates = function() {
          // determine the party of the candidate that has won a direct mandate for
          // each district.
          return _.map(self.districts(), function(district) {
            // get all the relevant results for party candidates. 
            var results = _.filter(self._admin_results('district', district.id), function(r) {
              return r.is_party && r.vote_type == 'Erststimmen' && r.type != 'Vorperiode';
            });
            var winner = undefined,
                bestResult = _.max(results, function(r) { return r.votes; });
            
            // if there is a primary vote candidate with the most votes:
            if (bestResult && bestResult.votes > 0) {
              winner = bestResult.group;
            }

            // TODO: maybe only call it if a certain percentage of voters have 
            // cast their ballot?
            return [district.label, winner];
          });
        }

        
      };


      d3.text('data/kerg.csv', 'text/plain; charset=iso-8859-1', function(data) {
        var results = parseResults(data),
            election = new Election(results);

        console.log(election.directMandates());
        //console.log(results);
        console.log('done!');
      });
    </script>
  </body>
</html>
