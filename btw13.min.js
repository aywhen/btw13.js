// Bundestagswahl Tabulator, MIT Licensed. (C) Friedrich Lindenberg
var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.STATE_SEATS={1:22,2:13,3:59,4:5,5:128,6:43,7:30,8:76,9:92,10:7,11:24,12:19,13:13,14:32,15:15,16:17};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.reduce_sum=function(e,t){return e+t},Bundestagswahl.saint_lague_iterative=function(e,t,n){var r=_.reduce(_.values(e),Bundestagswahl.reduce_sum,0),i=r/t,s=i/2,o={};for(;;){_.each(e,function(e,t){var r=Math.max(Math.round(e/i),n[t]||0);o[t]=r}),seats_given=_.reduce(_.values(o),Bundestagswahl.reduce_sum,0);if(seats_given==t)return o;seats_given>t?i+=s:i-=s,s*=.8}};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.parseResults=function(e){function t(e){return!e||e.trim().length===0}function n(e){return t(e)?0:parseInt(e,10)}function r(e){var n=null;return e.map(function(e){return t(e)?n:(n=e,e)})}var i=e.split("\n").map(function(e){return e.split(";")}),s=[];s.election_name=i.shift()[0],s.result_type=i.shift()[0];var o=r(i.shift()).slice(3),u=r(i.shift()).slice(3),a=r(i.shift()).slice(3);return _.each(i,function(e,t){var r=n(e.shift()),i=e.shift(),f=n(e.shift()),l=f===99?"state":"district";l=f===0?"federal":l;if(r===0)return;_.each(e,function(e,t){s.push({is_party:t>15,admin_id:r,admin_label:i,parent_id:f,admin_level:l,group:o[t],vote_type:u[t],type:a[t],votes:n(e)})})}),s};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.Tabulator=function(e,t){var n=this;n.results=e,n._filter_admin=function(e){var t=_.filter(n.results,function(t){return t.admin_level===e}),r=_.map(t,function(e){return{id:e.admin_id,label:e.admin_label,parent_id:e.parent_id}});return _.uniq(r,function(e){return e.id})},n.districts=_.memoize(_.partial(n._filter_admin,"district")),n.states=_.memoize(_.partial(n._filter_admin,"state")),n.regularSeatsCount=_.memoize(function(){return n.districts().length*2}),n._admin_results=function(e,t){return _.filter(n.results,function(n){return n.admin_level===e&&n.admin_id===t})},n.parties=function(){return _.uniq(_.pluck(_.filter(e,function(e){return e.is_party}),"group"))},n.directMandates=_.memoize(function(){var e=_.map(n.districts(),function(e){var r=_.filter(n._admin_results("district",e.id),function(e){return e.is_party&&e.vote_type=="Erststimmen"&&e.type==t}),i,s=_.max(r,function(e){return e.votes});return s&&s.votes>0&&(i=s.group),[e.id,i]});return _.object(e)}),n.directMandatesByParty=_.memoize(function(){return _.countBy(_.pairs(n.directMandates()),function(e){return e[1]})}),n.directMandatesByStateAndParty=_.memoize(function(){var e=n.directMandates(),t=_.groupBy(n.districts(),function(e){return e.parent_id});return seats=_.map(t,function(t,n){return[n,_.countBy(t,function(t){return e[t.id]})]}),_.object(seats)}),n.totalValidNationalSecondaryVotes=_.memoize(function(){var e=_.find(n._admin_results("federal",99),function(e){return e.vote_type=="Zweitstimmen"&&e.type==t&&e.group=="GÃ¼ltige"});return e?e.votes:0}),n.totalNationalSecondaryVotesByParty=_.memoize(function(){var e=_.filter(n._admin_results("federal",99),function(e){return e.vote_type=="Zweitstimmen"&&e.type==t&&e.is_party});return _.object(_.map(e,function(e){return[e.group,e.votes]}))}),n.secondaryResultsByState=_.memoize(function(){var e={};return _.each(n.states(),function(r){var i=_.filter(n._admin_results("state",r.id),function(e){return e.vote_type=="Zweitstimmen"&&e.type==t&&e.is_party});e[r.id]=_.object(_.map(i,function(e){return[e.group,e.votes]}))}),e}),n.factions=_.memoize(function(){var e=[];_.each(n.directMandatesByParty(),function(t,n){t>=3&&e.push(n)});var t=n.totalValidNationalSecondaryVotes();return _.each(n.totalNationalSecondaryVotesByParty(),function(n,r){n/t>=.05&&e.push(r)}),_.uniq(e)}),n.nonFactionSeatsByState=_.memoize(function(){var e=n.factions(),t=_.map(n.directMandatesByStateAndParty(),function(t,n){var r=_.reduce(_.pairs(t),function(t,n){return _.contains(e,n[0])?t:t+n[1]},0);return[n,r]});return _.object(t)}),n.nationalNonFactionSeats=function(){return _.reduce(_.values(n.nonFactionSeatsByState()),Bundestagswahl.reduce_sum,0)},n.availableSeatsByState=_.memoize(function(){var e=_.map(n.nonFactionSeatsByState(),function(e,t){return[t,Bundestagswahl.STATE_SEATS[t]-e]});return _.object(e)}),n.minimalSeatsByParty=_.memoize(function(){var e=n.directMandatesByStateAndParty(),t=n.availableSeatsByState(),r=n.factions(),i={},s=_.map(n.secondaryResultsByState(),function(n,i){n=_.object(_.filter(_.pairs(n),function(e){return _.contains(r,e[0])}));var s=Bundestagswahl.saint_lague_iterative(n,t[i],{});return _.each(s,function(t,n){var r=e[i][n]||0;s[n]=Math.max(t,r)}),s});return _.each(s,function(e){_.each(e,function(e,t){i[t]=i[t]?i[t]+e:e})}),i}),n.make_divisor=function(e,t){var n=_.map(e,function(e,n){return e/(t[n]-.5)});return _.min(n)},n.upperDistribution=_.memoize(function(){console.log("Errechne Oberverteilung...");var e=n.regularSeatsCount()-n.nationalNonFactionSeats(),t=n.minimalSeatsByParty(),r=n.factions(),i=n.totalNationalSecondaryVotesByParty();i=_.object(_.filter(_.pairs(i),function(e){return _.contains(r,e[0])}));var s=n.make_divisor(i,t),o={};return _.each(i,function(e,t){o[t]=Math.round(e/s)}),o}),n.lowerDistribution=_.memoize(function(){console.log("Errechne Unterverteilung...");var e=n.secondaryResultsByState(),t=n.upperDistribution(),r={},i=n.directMandatesByStateAndParty();return _.each(t,function(t,n){var s={};_.each(e,function(e,t){s[t]=e[n]});var o={};_.each(i,function(e,t){o[t]=e[n]}),r[n]=Bundestagswahl.saint_lague_iterative(s,t,o)}),r}),n.tabulate=function(){var e={},t={},r=n.upperDistribution(),i=n.lowerDistribution(),s=n.factions(),o=n.directMandatesByParty(),u=n.directMandatesByStateAndParty(),a=n.totalNationalSecondaryVotesByParty(),f=n.secondaryResultsByState();return _.each(n.parties(),function(t){var n=_.contains(s,t),i=n?r[t]:o[t]||0;e[t]={is_faction:n,total_seats:i,direct_mandates:o[t]||0,secondary_votes:a[t]}}),_.each(n.states(),function(e){var r={};_.each(n.parties(),function(t){var n=u[e.id][t]||0,s=i[t]?i[t][e.id]||n:n;r[t]={total_seats:s,direct_mandates:n,secondary_votes:f[e.id][t]||0}}),t[e.id]={label:e.label,parties:r}}),{summary:{election:n.results.election_name,result:n.results.result_type,valid_votes:n.totalValidNationalSecondaryVotes(),regular_seats:n.regularSeatsCount()},parties:e,states:t}}};