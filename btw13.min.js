// Bundestagswahl Tabulator, MIT Licensed. (C) Friedrich Lindenberg
var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.STATE_SEATS={1:22,2:13,3:59,4:5,5:128,6:43,7:30,8:76,9:92,10:7,11:24,12:19,13:13,14:32,15:15,16:17};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.reduce_sum=function(e,t){return e+t},Bundestagswahl.saint_lague_iterative=function(e,t,n){var r=_.reduce(_.values(e),Bundestagswahl.reduce_sum,0),i=r/t,s=i/2,o={};for(;;){_.each(e,function(e,t){var r=Math.max(Math.round(e/i),n[t]||0);o[t]=r}),seats_given=_.reduce(_.values(o),Bundestagswahl.reduce_sum,0);if(seats_given==t)return o;seats_given>t?i+=s:i-=s,s*=.8}};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.parseResults=function(e){function t(e){return!e||e.trim().length===0}function n(e){return t(e)?0:parseInt(e,10)}function r(e){var n=null;return e.map(function(e){return t(e)?n:(n=e,e)})}var i=e.split("\n").map(function(e){return e.split(";")}),s=[];s.election_name=i.shift()[0],s.result_type=i.shift()[0];var o=r(i.shift()).slice(3),u=r(i.shift()).slice(3),a=r(i.shift()).slice(3);return _.each(i,function(e,t){var r=n(e.shift()),i=e.shift(),f=n(e.shift()),l=f===99?"state":"district";l=f===0?"federal":l;if(r===0)return;_.each(e,function(e,t){s.push({is_party:t>15,admin_id:r,admin_label:i,parent_id:f,admin_level:l,group:o[t],vote_type:u[t],type:a[t],votes:n(e)})})}),s};var Bundestagswahl=Bundestagswahl||{};Bundestagswahl.Tabulator=function(e){var t=this;t.results=e,t._filter_admin=function(e){var n=_.filter(t.results,function(t){return t.admin_level===e}),r=_.map(n,function(e){return{id:e.admin_id,label:e.admin_label,parent_id:e.parent_id}});return _.uniq(r,function(e){return e.id})},t.districts=_.memoize(_.partial(t._filter_admin,"district")),t.states=_.memoize(_.partial(t._filter_admin,"state")),t.regularSeatsCount=_.memoize(function(){return t.districts().length*2}),t._admin_results=function(e,n){return _.filter(t.results,function(t){return t.admin_level===e&&t.admin_id===n})},t.parties=function(){return _.uniq(_.pluck(_.filter(e,function(e){return e.is_party}),"group"))},t.directMandates=_.memoize(function(){var e=_.map(t.districts(),function(e){var n=_.filter(t._admin_results("district",e.id),function(e){return e.is_party&&e.vote_type=="Erststimmen"&&e.type!="Vorperiode"}),r,i=_.max(n,function(e){return e.votes});return i&&i.votes>0&&(r=i.group),[e.id,r]});return _.object(e)}),t.directMandatesByParty=_.memoize(function(){return _.countBy(_.pairs(t.directMandates()),function(e){return e[1]})}),t.directMandatesByStateAndParty=_.memoize(function(){var e=t.directMandates(),n=_.groupBy(t.districts(),function(e){return e.parent_id});return seats=_.map(n,function(t,n){return[n,_.countBy(t,function(t){return e[t.id]})]}),_.object(seats)}),t.totalValidNationalSecondaryVotes=_.memoize(function(){var e=_.find(t._admin_results("federal",99),function(e){return e.vote_type=="Zweitstimmen"&&e.type!="Vorperiode"&&e.group=="GÃ¼ltige"});return e?e.votes:0}),t.totalNationalSecondaryVotesByParty=_.memoize(function(){var e=_.filter(t._admin_results("federal",99),function(e){return e.vote_type=="Zweitstimmen"&&e.type!="Vorperiode"&&e.is_party});return _.object(_.map(e,function(e){return[e.group,e.votes]}))}),t.secondaryResultsByState=_.memoize(function(){var e={};return _.each(t.states(),function(n){var r=_.filter(t._admin_results("state",n.id),function(e){return e.vote_type=="Zweitstimmen"&&e.type!="Vorperiode"&&e.is_party});e[n.id]=_.object(_.map(r,function(e){return[e.group,e.votes]}))}),e}),t.factions=_.memoize(function(){var e=[];_.each(t.directMandatesByParty(),function(t,n){t>=3&&e.push(n)});var n=t.totalValidNationalSecondaryVotes();return _.each(t.totalNationalSecondaryVotesByParty(),function(t,r){t/n>=.05&&e.push(r)}),_.uniq(e)}),t.nonFactionSeatsByState=_.memoize(function(){var e=t.factions(),n=_.map(t.directMandatesByStateAndParty(),function(t,n){var r=_.reduce(_.pairs(t),function(t,n){return _.contains(e,n[0])?t:t+n[1]},0);return[n,r]});return _.object(n)}),t.nationalNonFactionSeats=function(){return _.reduce(_.values(t.nonFactionSeatsByState()),Bundestagswahl.reduce_sum,0)},t.availableSeatsByState=_.memoize(function(){var e=_.map(t.nonFactionSeatsByState(),function(e,t){return[t,Bundestagswahl.STATE_SEATS[t]-e]});return _.object(e)}),t.minimalSeatsByParty=_.memoize(function(){var e=t.directMandatesByStateAndParty(),n=t.availableSeatsByState(),r=t.factions(),i={},s=_.map(t.secondaryResultsByState(),function(t,i){t=_.object(_.filter(_.pairs(t),function(e){return _.contains(r,e[0])}));var s=Bundestagswahl.saint_lague_iterative(t,n[i],{});return _.each(s,function(t,n){var r=e[i][n]||0;s[n]=Math.max(t,r)}),s});return _.each(s,function(e){_.each(e,function(e,t){i[t]=i[t]?i[t]+e:e})}),i}),t.make_divisor=function(e,t){var n=_.map(e,function(e,n){return e/(t[n]-.5)});return _.min(n)},t.upperDistribution=_.memoize(function(){console.log("Errechne Oberverteilung...");var e=t.regularSeatsCount()-t.nationalNonFactionSeats(),n=t.minimalSeatsByParty(),r=t.factions(),i=t.totalNationalSecondaryVotesByParty();i=_.object(_.filter(_.pairs(i),function(e){return _.contains(r,e[0])}));var s=t.make_divisor(i,n),o={};return _.each(i,function(e,t){o[t]=Math.round(e/s)}),o}),t.lowerDistribution=_.memoize(function(){console.log("Errechne Unterverteilung...");var e=t.secondaryResultsByState(),n=t.upperDistribution(),r={},i=t.directMandatesByStateAndParty();return _.each(n,function(t,n){var s={};_.each(e,function(e,t){s[t]=e[n]});var o={};_.each(i,function(e,t){o[t]=e[n]}),r[n]=Bundestagswahl.saint_lague_iterative(s,t,o)}),r}),t.tabulate=function(){var e={},n={},r=t.upperDistribution(),i=t.lowerDistribution(),s=t.factions(),o=t.directMandatesByParty(),u=t.directMandatesByStateAndParty(),a=t.totalNationalSecondaryVotesByParty(),f=t.secondaryResultsByState();return _.each(t.parties(),function(t){var n=_.contains(s,t),i=n?r[t]:o[t]||0;e[t]={is_faction:n,total_seats:i,direct_mandates:o[t]||0,secondary_votes:a[t]}}),_.each(t.states(),function(e){var r={};_.each(t.parties(),function(t){var n=u[e.id][t]||0,s=i[t]?i[t][e.id]||n:n;r[t]={total_seats:s,direct_mandates:n,secondary_votes:f[e.id][t]||0}}),n[e.id]={label:e.label,parties:r}}),{summary:{election:t.results.election_name,result:t.results.result_type,valid_votes:t.totalValidNationalSecondaryVotes(),regular_seats:t.regularSeatsCount()},parties:e,states:n}}};