<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <title>btw13.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://assets.pudo.org/spiegel/fonts/fonts.css" />
    <link rel="stylesheet" type="text/css" href="css/bigboard.css" />
    <link rel="shortcut icon" href="http://assets.pudo.org/img/favicon.ico">

  </head>
  <body>

    <div id="airlock">
      <div class="container loading">
        <div class="row">
          <div class="col-md-12">
            Ergebnisse werden geladen und tabuliert...
          </div>
        </div>
      </div>
    </div>

    <script id="bigboard-template" type="text/x-handlebars-template">
      <header class="container">
        <div class="row">
          <div class="col-md-10">
            <div class="election-name">{{summary.election}}</div>
          </div>
          <div class="col-md-2">
            <div class="mark-temporary">{{summary.result}}</div>
          </div>
        <div>
      </header>

      <div class="container">
        {{#parties}}
          <div class="row result {{classes}}">
            <div class="col-md-2 party-name fg-{{slug}} light">
              {{name}}
            </div>
            <div class="col-md-2 numeric">
              {{percentage}}%
            </div>
            <div class="col-md-1">
              <span class="trend {{percentage_trend}}">{{percentage_diff_text}}</span>
            </div>
            <div class="col-md-2 numeric">
              {{direct_mandates}} <span class="legend">Kreise</span>
            </div>
            <div class="col-md-1">
              <span class="trend {{direct_mandates_trend}}">{{direct_mandates_diff_text}}</span>
            </div>
            <div class="col-md-2 numeric">
              {{total_seats}}
              <span class="legend">Sitze</span>
            </div>
            <div class="col-md-1">
              <span class="trend {{total_seats_trend}}">{{total_seats_diff_text}}</span>
            </div>
            <!--div class="col-md-2 numeric">
              {{secondary_votes}}
            </div-->
          </div>
        {{/parties}}
      </div>

      <footer class="container">
        <div class="row">
          <div class="col-md-12">
            <a href="https://github.com/pudo/btw13.js">btw13.js</a>: Auswertung auf Basis der Daten des Bundeswahlleiters.
          </div>
        <div>
      </footer>
    </script>
    
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.1/underscore-min.js" charset="utf-8"></script>

    <script src="btw13.min.js" charset="utf-8"></script>
    <script>
      $(function() {
        var template = Handlebars.compile($('#bigboard-template').html());

        function numericTrend(n) {
          if (n==0) return 'neutral';
          if (n>0) return 'increase';
          return 'decrease';
        }

        function trendText(n) {
          if (parseFloat(n)==0) return '';
          if (parseFloat(n)>0) return '+' + n;
          return '' + n; 
        }

        function partySlug(name) {
          name = name.toLowerCase().replace(/ü/g, 'u').replace(/ä/g, 'a')
          return name.replace(/ö/g, 'o').replace(/[^a-zA-Z0-9]/g, '');
        }

        function handleData(data) {
          var results = Bundestagswahl.parseResults(data),
              tabulator = new Bundestagswahl.Tabulator(results, results.result_type),
              tab = tabulator.tabulate(),
              previous_tabulator = new Bundestagswahl.Tabulator(results, 'Vorperiode'),
              previous_tab = previous_tabulator.tabulate();

          // Format party results.
          tab.parties = _.map(tab.parties, function(v, k) {
            var pv = previous_tab.parties[k];
            v.name = k;
            v.slug = partySlug(k);

            v.percentage_num = (v.secondary_votes / tab.summary.valid_votes*100)
            v.prev_percentage = (pv.secondary_votes / previous_tab.summary.valid_votes*100)
            v.percentage = v.percentage_num.toFixed(1);

            v.percentage_diff = v.percentage_num - v.prev_percentage;
            v.percentage_trend = numericTrend(v.percentage_diff);
            v.percentage_diff_text = trendText(v.percentage_diff.toFixed(1));

            v.total_seats_diff = v.total_seats - pv.total_seats;
            v.total_seats_trend = numericTrend(v.total_seats_diff);
            v.total_seats_diff_text = trendText(v.total_seats_diff);

            v.direct_mandates_diff = v.direct_mandates - pv.direct_mandates;
            v.direct_mandates_trend = numericTrend(v.direct_mandates_diff);
            v.direct_mandates_diff_text = trendText(v.direct_mandates_diff);

            //console.log(v);
            v.classes = [];
            if (v.total_seats > 0) v.classes.push('elected');
            if (v.is_fraktion > 0) v.classes.push('faction');
            v.classes = v.classes.join(' ');
            return v;
          });
          tab.parties = _.filter(tab.parties, function(e) {
            return e.percentage_num > 0.4;
          });
          tab.parties = _.sortBy(tab.parties, function(e) {
            return e.percentage_num * -1;
          });
          console.log(tab);
          $('#airlock').html(template(tab));
        }

        $.ajax({
          url: 'data/kerg.csv',
          dataType: 'text',
          success: handleData,
          mimeType: 'text/plain; charset=iso-8859-1'
        });
        
      });
    </script>
  </body>
</html>
